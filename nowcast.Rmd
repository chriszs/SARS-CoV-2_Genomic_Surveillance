---
title: "CDC variant surveillance system"
subtitle: "Code accompanying MMWR on Genomic Surveillance"
author: Prabasaj Paul (VIG5@CDC.GOV)
date: 2021-05-11
output: html_notebook
---

# Part 1: From data to survey design
 
Loads [software package](https://r-survey.r-forge.r-project.org/survey/) for survey data analysis.

```{r}
library(survey)
```

Per [the docs](https://r-survey.r-forge.r-project.org/survey/exmample-lonely.html), "Difficulties in estimating variances also arise when only one [primary sampling units] in a stratum has observations in a particular domain or subpopulation. R gives a warning rather than an error when this occurs, and can optionally apply the 'adjust' and "average' corrections. To apply the corrections, set"

```{r}
options(survey.adjust.domain.lonely = T,
        survey.lonely.psu = "average")
```

Loads sequence data, test tallies by state and collection date, state populations:

```{r}
load("Code/variant_survey_dat_example.RData")
```

Some general parameters:

```{r}
week0day1 = as.Date("2020-01-05") # First Sunday in 2020

week0day1
```

HHS regions:

```{r}
HHS_reg = list(
  HHS1 = c("CT", "ME", "MA", "NH", "RI", "VT"),
  HHS2 = c("NJ", "NY", "PR", "VI"),
  HHS3 = c("DE", "DC", "MD", "PA", "VA", "WV"),
  HHS4 = c("AL", "FL", "GA", "KY", "MS", "NC", "SC", "TN"),
  HHS5 = c("IL", "IN", "MI", "MN", "OH", "WI"),
  HHS6 = c("AR", "LA", "NM", "OK", "TX"),
  HHS7 = c("IA", "KS", "MO", "NE"),
  HHS8 = c("CO", "MT", "ND", "SD", "UT", "WY"),
  HHS9 = c("AZ", "CA", "HI", "NV", "AS", "MP", "GU", "MH"),
  HHS10 = c("AK", "ID", "OR", "WA")
)
```

Territory 2020-07-01 populations from https://en.wikipedia.org/wiki/List_of_states_and_territories_of_the_United_States_by_population (2021-04-19)
Marshall Islands 2018 estimate https://en.wikipedia.org/wiki/Marshall_Islands (2021-04-19)

```{r}
pops = rbind(pops, data.frame(
  STUSAB = c("AS", "GU", "MP", "VI", "MH"),
  `Total.` = c(49437, 168485, 51433, 106235, 58413)
))

pops
```

```{r}
hhs = data.frame(STUSAB = toupper(pops$STUSAB))
hhs$HHS = sapply(hhs$STUSAB, grep, HHS_reg)

hhs
```
## Subset by time and place: USA, states with two letter abbreviations, human host, reasonable collection date

U.S., legitimately coded states, human host; dat may already be subset to US, but retained for backward compatibility

```{r}
us.dat = subset(dat,
                primary_country %in% c("United States", "USA") &
                  primary_host == "Human")
us.dat = subset(us.dat, nchar(primary_state_abv) == 2)
```

Get unique records in Hadoop table (2021-04-26)

```{r}
us.dat = unique(us.dat)
pangolin = unique(pangolin)
baseline = unique(baseline)
```

Disambiguate and remove unreasonable dates

```{r}
us.dat$collection_date = as.Date(us.dat$primary_collection_date)
us.dat$collection_date = with(us.dat, as.Date(ifelse(
  is.na(collection_date),
  as.Date(primary_collection_date_dt),
  collection_date
), origin = "1970-01-01"))
if ("covv_subm_date" %in% names(us.dat))
  us.dat$covv_subm_date = as.Date(us.dat$covv_subm_date)
if ("contractor_receive_date_to_cdc" %in% names(us.dat))
  us.dat$contractor_receive_date_to_cdc = as.Date(us.dat$contractor_receive_date_to_cdc)
us.dat$yr_wk = as.character(us.dat$collection_date - as.numeric(strftime(us.dat$collection_date, format =
                                                                           "%w")))
us.dat$DAY = as.numeric(us.dat$collection_date - week0day1)
us.dat = subset(us.dat, collection_date >= as.Date("2019-10-01"))
```

## Nowcast

Loads software package for feed-forward neural networks and multinomial log-linear models.

```{r}
library(nnet)
```

Top by variant share that must be included in output:

```{r}
n_top = 10
```

Window for estimates:

```{r}
n_recent_weeks = 4
```

Lookback for modeling:

```{r}
model_weeks = 16
```

```{r}
week0day1 = get0("week0day1", ifnotfound = as.Date("2020-01-05"))
```

```{r}
current_week = as.numeric(Sys.Date() - week0day1) %/% 7
```

List of variants to track (not just variants of concern or variants of interest):

```{r}
voc = c(
  "B.1.2",
  "B.1.1.7",
  "B.1.429",
  "B.1.596",
  "B.1.427",
  "B.1",
  "B.1.1.519",
  "B.1.526",
  "B.1.526.1",
  "B.1.526.2",
  "P.2",
  "B.1.351",
  "B.1.525",
  "P.1",
  "P.2",
  "B.1.617",
  "B.1.617.1",
  "B.1.617.2",
  "B.1.617.3"
)
```

Example of mutation sets to track:

```{r}
moi = c("L452R", "E484K")
```

As per CDC proposed modeling scenarios (2021-03-19):

```{r}
mean_generation_time = 6 / 7 # weeks
```

Estimated degrees of freedom = number of clusters - number of strata:

```{r}
dfs = aggregate(svyREG$cluster$SOURCE, list(USA_or_HHSRegion = svyREG$strata$HHS), function(xx)
  length(unique(xx)))
dfs = rbind(data.frame(USA_or_HHSRegion = "USA", x = sum(dfs$x) - nrow(dfs)), dfs)

dfs
```


```{r}
us_var = sort(prop.table(xtabs(
  SIMPLE_ADJ_WT ~ VARIANT,
  subset(src.dat, week >= current_week - n_recent_weeks &
           VARIANT != "None")
)),
decreasing = TRUE)

us_var
```


